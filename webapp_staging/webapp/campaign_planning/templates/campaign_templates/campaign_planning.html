{% extends "base_header_main.html" %}
{% load static %}

{% block title %}
    Welcome To SMC Tracker
{% endblock %}

{% block content %}

<div class="text-center my-6">
    <h1 class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-green-400 via-green-500 to-green-600 bg-clip-text text-transparent drop-shadow-md">
        Add New Campaign Data
    </h1>
    <div class="w-32 h-1 mx-auto mt-2 bg-green-500 rounded-full shadow-lg"></div>
</div>

<div class="grid grid-cols-3 p-10">
    <div class="col-span-3 flex justify-end items-center space-x-4">
        <!-- Fancy Info Text -->
        <span class="relative inline-block px-4 py-2 text-xl font-extrabold italic tracking-wider
            bg-gradient-to-r from-green-700 via-green-700 to-green-700 bg-clip-text text-transparent
            drop-shadow-md after:content-[''] after:absolute after:inset-0 after:rounded-full
            after:border-2 after:border-green-700 after:animate-pulse">
            FOR LATEST CAMPAIGN SYNCHRONIZATION PROCESS (EOC ‚Üí SMC)
        </span>


        <!-- Sync Button -->
        <div>
            <button id="syncnewcampaign"
                    class="flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl px-6 py-3 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer">
                <!-- SVG Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 4v6h6M20 20v-6h-6M4 20h6v-6M20 4h-6v6"/>
                </svg>
                Sync Campaign
            </button>
        </div>
    </div>
</div>


<div class="grid grid-cols-12">
    <div class="md:col-span-12">
        <table id="campaignTable"
               class="min-w-full border-collapse border border-gray-300 shadow-lg rounded-lg overflow-hidden text-gray-700">
            <thead class="bg-green-500 text-white">
            <tr>
                <th rowspan="2" class="px-4 py-3 text-left border-r border-white">Sr#</th>
                <th rowspan="2" class="px-4 py-3 text-left border-r border-white">Campaign Name</th>
                <th rowspan="2" class="px-4 py-3 text-left border-r border-white">Campaign Code</th>
                <th rowspan="2" class="px-4 py-3 text-left border-r border-white">Start Date</th>
                <th rowspan="2" class="px-4 py-3 text-left border-r border-white">End Date</th>

                <!-- New Main Scope column -->
                <th colspan="5" class="px-4 py-3 text-center border-l border-white">Finalize Scope</th>

                <!-- Existing Planning column -->
                <th colspan="4" class="px-4 py-3 text-center border-l border-white">Campaign Status</th>
            </tr>
            <tr class="bg-green-300 bg-opacity-30">
                <!-- Sub-columns under Main Scope -->
                <th class="px-4 py-2 border-l border-white text-center">Province</th>
                <th class="px-4 py-2 border-l border-white text-center">Division</th>
                <th class="px-4 py-2 border-l border-white text-center">District</th>
                <th class="px-4 py-2 border-l border-white text-center">Tehsil</th>
                <th class="px-4 py-2 border-l border-white text-center">UC</th>

                <!-- Sub-columns under Planning -->
                <th class="px-4 py-2 border-l border-white text-center">Planning</th>
                <th class="px-4 py-2 border-l border-white text-center">Insertion</th>
                <th class="px-4 py-2 border-l border-white text-center">Deletion</th>
                <th class="px-4 py-2 border-l border-white text-center">Update</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            {% for campaign in summary.campaigns %}
            <tr class="hover:bg-green-50 transition duration-150">
                <td class="px-4 py-2 text-center border-r">{{ forloop.counter }}</td>
                <td class="px-4 py-2 border-r">{{ campaign.name }}</td>
                <td class="px-4 py-2 border-r">{{ campaign.campaign_code }}</td>
                <td class="px-4 py-2 border-r">{{ campaign.date_from }}</td>
                <td class="px-4 py-2 border-r">{{ campaign.date_to }}</td>

                <!-- Main Scope data -->
                <td class="px-4 py-2 text-center border-l">{{ campaign.unique_province_count }}</td>
                <td class="px-4 py-2 text-center border-l">{{ campaign.unique_divid_count }}</td>
                <td class="px-4 py-2 text-center border-l">{{ campaign.unique_district_count }}</td>
                <td class="px-4 py-2 text-center border-l">{{ campaign.unique_tehsil_count }}</td>
                <td class="px-4 py-2 text-center border-l">{{ campaign.unique_uc_count }}</td>

                <!-- Planning checkboxes -->
                <td class="px-4 py-2 text-center border-l">
                    <input type="checkbox"
                           {% if campaign.plan == 1 %}checked{% endif %}
                           onclick="handleStatusChange('plan', this.checked ? 1 : 0, {{ campaign.idcampaign }}, '{{ campaign.campaign_code }}')"
                           class="w-10 h-10 accent-green-500 bg-gray-100 border-2 border-gray-300 rounded-xl shadow-lg
                                  hover:scale-110 hover:shadow-green-300 transition-all duration-200 ease-out">
                </td>
                <td class="px-4 py-2 text-center border-l">
                    <input type="checkbox"
                           {% if campaign.insert == 1 %}checked{% endif %}
                           onclick="handleStatusChange('insert', this.checked ? 1 : 0, {{ campaign.idcampaign }}, '{{ campaign.campaign_code }}')"
                           class="w-10 h-10 accent-blue-500 bg-gray-100 border-2 border-gray-300 rounded-xl shadow-lg
                                  hover:scale-110 hover:shadow-blue-300 transition-all duration-200 ease-out">
                </td>
                <td class="px-4 py-2 text-center border-l">
                    <input type="checkbox"
                           {% if campaign.delete == 1 %}checked{% endif %}
                           onclick="handleStatusChange('delete', this.checked ? 1 : 0, {{ campaign.idcampaign }}, '{{ campaign.campaign_code }}')"
                           class="w-10 h-10 accent-red-500 bg-gray-100 border-2 border-gray-300 rounded-xl shadow-lg
                                  hover:scale-110 hover:shadow-red-300 transition-all duration-200 ease-out">
                </td>
                <td class="px-4 py-2 text-center border-l">
                    <input type="checkbox"
                           {% if campaign.update == 1 %}checked{% endif %}
                           onclick="handleStatusChange('update', this.checked ? 1 : 0, {{ campaign.idcampaign }}, '{{ campaign.campaign_code }}')"
                           class="w-10 h-10 accent-yellow-400 bg-gray-100 border-2 border-gray-300 rounded-xl shadow-lg
                                  hover:scale-110 hover:shadow-yellow-300 transition-all duration-200 ease-out">
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<style>
    /* Fancy custom checkboxes */
    input[type="checkbox"].fancy:checked {
        @apply bg-green-500 border-green-500;
    }

    input[type="checkbox"].fancy {
        @apply w-8 h-8 rounded-lg border-2 border-green-400 accent-green-500 cursor-pointer transition-all duration-300;
    }

    /* Tailwind-styled DataTables search input */
    .dataTables_filter input {
        @apply border border-gray-400 rounded-md px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400;
    }

    /* DataTables controls alignment */
    .dataTables_wrapper .dataTables_filter {
        @apply float-right mb-2;
    }

    .dataTables_wrapper .dataTables_paginate {
        @apply float-left mt-2;
    }

    /* Fancy Prev/Next buttons */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        @apply bg-green-500 text-white px-3 py-1 rounded-lg mx-1 hover:bg-green-600 transition;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        @apply bg-green-700 font-bold;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
        @apply bg-gray-300 text-gray-500 cursor-not-allowed;
    }
</style>
<script>

    $(document).ready(function () {
        var table = $('#campaignTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            pageLength: 20,
            lengthMenu: [1, 2, 5, 10, 20, 25, 50],
            dom: '<"flex justify-between mb-2"lpf>rt<"mt-2"i>',
            initComplete: function () {
                // Style the search input
                var searchInput = $('#campaignTable_filter input');
                searchInput.addClass('border border-gray-400 rounded-md px-3 py-2 w-64 focus:outline-none');
            },
            drawCallback: function () {
                // Style Prev/Next buttons on every draw
                var paginateContainer = $('#campaignTable_paginate');
                var prevBtn = paginateContainer.find('.previous');
                var nextBtn = paginateContainer.find('.next');

                var prevHtml = `
                <button type="button" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-lg px-4 py-3 inline-flex items-center me-1">
                    <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5H1m0 0l4-4m-4 4l4 4"/>
                    </svg>
                    <span class="sr-only">Previous</span>
                </button>
            `;
                var nextHtml = `
                <button type="button" class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-lg px-4 py-3 inline-flex items-center ms-1">
                    <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5h12m0 0L9 1m4 4L9 9"/>
                    </svg>
                    <span class="sr-only">Next</span>
                </button>
            `;

                prevBtn.html(prevHtml);
                nextBtn.html(nextHtml);

                // Style numeric paginate buttons
                paginateContainer.find('.paginate_button').not('.previous, .next').addClass(
                    'bg-white border border-gray-300 px-3 py-1 rounded-md mx-0.5 text-gray-700 hover:bg-green-100 transition'
                );
                paginateContainer.find('.paginate_button.current').addClass('bg-green-500 text-white font-bold');
                paginateContainer.find('.paginate_button.disabled').addClass('bg-gray-200 text-gray-500 cursor-not-allowed');
            }
        });
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { API_BASE_URL } from "/static/apiConfig.js";
    window.API_BASE_URL = API_BASE_URL;
</script>

<script>
async function handleStatusChange(type, status, campaignId, campaignCode) {
    console.log("Type:", type, "Status:", status, "Campaign ID:", campaignId, "Campaign Code:", campaignCode);
    try {
        const response = await fetch(`${window.API_BASE_URL}/campaign/campaign/update-status`, {
            method: "POST",
            headers: {
                "accept": "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idcampaign: campaignId,
                type_field: type,
                status: status
            })
        });

        if (!response.ok) {
            throw new Error("Failed to update status");
        }

        const data = await response.json();
        console.log("Server response:", data);

        // Show SweetAlert success
        Swal.fire({
            title: "Updated!",
            text: `${type} status updated for ${campaignCode}`,
            icon: "success",
            timer: 1500,
            showConfirmButton: false
        });

        // Reload after 3 seconds
        setTimeout(() => {
            location.reload();
        }, 100);

    } catch (err) {
        console.error("Error:", err);

        Swal.fire({
            title: "Error!",
            text: "Failed to update status. Please try again.",
            icon: "error"
        });
    }
}

</script>
<script>
// ‚úÖ Get cookie helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
document.getElementById("syncnewcampaign").addEventListener("click", async function () {
    const jwtToken = "{{ jwt_token }}";   // from Django session
    const userId = "{{ user_info.idusers }}"; // from Django template
    console.log("üîë JWT:", jwtToken, "üë§ UserID:", userId);

    // Show loading SweetAlert
    Swal.fire({
        title: "Processing...",
        text: "Please wait while campaigns are syncing.",
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        const response = await fetch(`${window.API_BASE_URL}/campaign/synccampaign`, {
            method: "POST",
            headers: {
                "accept": "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                jwt_token: jwtToken,
                idusers: parseInt(userId)   // ensure integer
            })
        });

        const rawText = await response.text();   // get raw response
        console.log("üì• Raw sync response:", rawText);

        if (!response.ok) {
            // Try parsing JSON error if possible
            let errorMsg = rawText;
            try {
                const errJson = JSON.parse(rawText);
                errorMsg = errJson.detail || JSON.stringify(errJson);
            } catch (_) {}

            Swal.fire({
                title: `Error ${response.status}!`,
                text: errorMsg,
                icon: "error",
                timer: 3000,
                showConfirmButton: false
            });
            throw new Error(errorMsg);
        }

        // Parse JSON if successful
        const data = JSON.parse(rawText);
        console.log("‚úÖ Parsed sync response:", data);

        Swal.fire({
            title: "Sync Completed!",
            text: "Campaigns have been synchronized successfully.",
            icon: "success",
            timer: 3000,
            showConfirmButton: false
        });

        setTimeout(() => location.reload(), 3000);

    } catch (error) {
        console.error("‚ùå Error during sync:", error);
        // If we already showed a SweetAlert above, don‚Äôt override it here
    }
});


</script>

{% endblock %}
