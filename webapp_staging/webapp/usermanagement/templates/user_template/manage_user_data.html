{% extends "base_header_main.html" %}

{% load static %}

{% block title %}SMC - Manage User Module{% endblock %}

{% block content %}

<!--<h6>Hurrah another page created i am blessed by ALLAH (S.W.T)</h6>-->
<div class="flex justify-center mb-6 mt-2">
    <h2 class="text-[18px] md:text-[20px] font-semibold text-center text-gray-800 dark:text-white tracking-wide border-b-2 border-green-500 px-4 pb-1 shadow-sm">
        Search Users By Filters
    </h2>
</div>

<div class="w-full">
    <div class="">
        <form method="POST" class="grid grid-cols-12 gap-4 w-fit mx-auto" id="searchForm">
            {% csrf_token %}
            <!-- User Role -->
            <div class="col-span-12 md:col-span-1">
                <select id="userrole" name="userrole"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-blue-400 focus:ring focus:ring-blue-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option value="" disabled selected>User Role</option>
                    <option value="1">Administrator</option>
                    <option value="2">National Manager</option>
                    <option value="3">Province Manager</option>
                    <option value="11">Division Manager</option>
                    <option value="4">District Manager</option>
                    <option value="12">Tehsil Manager</option>
                    <option value="5">UC Manager</option>
                </select>
            </div>

            <!-- Province -->
            <div class="col-span-12 md:col-span-1">
                <select id="provincename" name="provincename"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-green-400 focus:ring focus:ring-green-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option disabled selected>Province</option>
                </select>
            </div>

            <!-- Division -->
            <div class="col-span-12 md:col-span-1">
                <select id="divisionname" name="divisionname"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-purple-400 focus:ring focus:ring-purple-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option disabled selected>Division</option>
                </select>
            </div>

            <!-- District -->
            <div class="col-span-12 md:col-span-1">
                <select id="districtname" name="districtname"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-yellow-400 focus:ring focus:ring-yellow-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option disabled selected>District</option>
                </select>
            </div>

            <!-- Tehsil -->
            <div class="col-span-12 md:col-span-1">
                <select id="tehsilname" name="tehsilname"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-pink-400 focus:ring focus:ring-pink-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option disabled selected>Tehsil</option>
                </select>
            </div>
            <div class="col-span-12 md:col-span-1">
                <select
                        id="affiliation" name="affiliation"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-pink-400 focus:ring focus:ring-pink-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option value="" disabled selected>Affiliation</option>
                    <option value="GOVERNMENT">Government</option>
                    <option value="BMGF">BMGF</option>
                    <option value="WHO">WHO</option>
                </select>
            </div>

            <div class="col-span-12 md:col-span-1">
                <select id="isadmin" name="isadmin"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-pink-400 focus:ring focus:ring-pink-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option value="" disabled selected>Is Admin</option>
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <!-- Status -->
            <div class="col-span-12 md:col-span-1">
                <select id="statuses" name="statuses"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-red-400 focus:ring focus:ring-red-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option disabled selected>Status</option>
                    <option value="1">Active</option>
                    <option value="0">InActive</option>
                </select>
            </div>
            <div class="col-span-12 md:col-span-1">
                <select id="gender" name="gender"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-red-400 focus:ring focus:ring-red-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option disabled selected>Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="col-span-12 md:col-span-1">
                <select id="userentry" name="userentry"
                        class="w-full h-10 rounded-xl border border-gray-300 bg-white px-3 text-[10px] text-gray-700 shadow-sm transition-all focus:border-red-400 focus:ring focus:ring-red-100 hover:shadow-md dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                    <option value="" disabled selected>Entry Type</option>
                    <option value="SMC">Still Missed</option>
                    <option value="ZD">Zero Dose</option>
                </select>
            </div>

            <!-- Search Button -->
            <div class="col-span-12 md:col-span-2 flex flex-col items-center">
                <button type="submit"
                        class="w-full h-10 rounded-xl bg-blue-600 text-white text-[10px] font-bold uppercase tracking-wide hover:bg-blue-700 shadow-md transition-all">
                    Search
                </button>
                <a href="#" id="resetLink" class="mt-1 text-xs text-blue-600 hover:underline cursor-pointer">Reset</a>
            </div>

        </form>
    </div>
</div>


<div class="mt-6 overflow-hidden rounded-2xl border border-gray-200 bg-white px-4 pb-3 pt-4 dark:border-gray-800 dark:bg-white/[0.03] sm:px-6">
    <div class="flex flex-col gap-2 mb-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-[20px] font-bold text-center text-gray-800 dark:text-white/90 tracking-wide mb-4 border-b-2 border-green-500 pb-2 w-fit mx-auto">
                User's Detail Information
            </h1>

        </div>

    </div>
    <div class="w-full overflow-x-auto">
        <table id="datatable" class="stripe min-w-full display border-collapse border border-gray-200 border-collapse">
            <thead class="bg-gray-50 text-[12px] text-gray-600 tracking-wide border border-gray-300">
            <tr class="border-b border-gray-200">
                <th class="pl-2 py-2" style="font-size: 9px;">Name</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Username</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Type</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Email</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Designation</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Province</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Division</th>
                <th class="pl-2 py-2" style="font-size: 9px;">District</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Tehsil</th>
                <th class="pl-2 py-2" style="font-size: 9px;">UC's</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Admin</th>
                <th class="pl-2 py-2" style="font-size: 9px;">Status</th>
                <th class="pl-2 py-2 text-center" style="font-size: 9px;">Actions</th>
            </tr>
            </thead>

            <tbody id="userTableBody" class="divide-y divide-gray-100 dark:divide-gray-800">

            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination" class="mt-4 flex justify-center space-x-2"></div>
    </div>

</div>
<style>
.loader {
  width: fit-content;
  font-weight: bold;
  font-family: monospace;
  font-size: 30px;
  background: linear-gradient(90deg, #000 50%, #0000 0) right/200% 100%;
  animation: l21 2s infinite linear;
}
.loader::before {
  content: "Loading...";
  color: #0000;
  padding: 0 5px;
  background: inherit;
  background-image: linear-gradient(90deg, #fff 50%, #000 0);
  -webkit-background-clip: text;
  background-clip: text;
}

@keyframes l21 {
  100% {
    background-position: left;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    async function fetchAndAppendUsers(limit = 500, offset = 0) {
        const tableBody = document.getElementById("userTableBody");
        const form = document.querySelector("form");  // Adjust selector if you have multiple forms

        // Build the query parameters from the form inputs
        const formData = new FormData(form);
        const params = new URLSearchParams();

        // Append limit and offset first
        params.append("limit", limit);
        params.append("offset", offset);

        // Append form values if present and not empty
        for (const [key, value] of formData.entries()) {
            if (value !== "" && value !== null) {
                params.append(key, value);
            }
        }

        // Build the URL with parameters
        const url = `{% url 'usermanagement:get_users_api' %}?${params.toString()}`;
        const response = await fetch(url);
        // const response = await fetch(`{% url 'usermanagement:get_users_api' %}?limit=${limit}&offset=${offset}`);
        const data = await response.json();
        const users = data.users || [];
        const completed = data.completed;

        // Append rows
        users.forEach(user => {
            const row = document.createElement("tr");
            row.className = "border-b border-gray-200";

            row.innerHTML = `
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.user_role_name || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.username || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.user_role_name || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.email || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.designation || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.province_name || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.division || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.district_name || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.tehsil_name || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.uc_names || '-'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${(user.is_province_admin + user.is_divisional_admin + user.is_district_admin + user.is_tehsil_admin) >= 1 ? 'Yes' : 'No'}</td>
                <td class="pl-2 py-3" style="font-size: 7pt;">${user.status_text || '-'}</td>
                <td class="pl-2 py-3 text-center space-x-2">
                    <div class="flex items-center gap-2 justify-center">
                        <div x-data="{ viewOpen: false }">

                            <!-- Trigger Button -->
                            <button @click="viewOpen = true; openViewUser(${user.idusers})"
                                    class="text-blue-500 hover:text-blue-700"
                                    title="View">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24"
                                     stroke="currentColor" stroke-width="2">
                                    <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
                                    <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
                                    <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
                                    <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
                                    <circle cx="12" cy="12" r="1"/>
                                    <path d="M18.944 12.33a1 1 0 0 0 0-.66 7.5 7.5 0 0 0-13.888 0 1 1 0 0 0 0 .66 7.5 7.5 0 0 0 13.888 0"/>
                                </svg>
                            </button>

                            <!-- Modal -->
                            <div id="userModal" x-show="viewOpen" x-cloak x-transition
                                 class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                                <div @click.away="viewOpen = false"
                                     class="relative bg-white p-8 rounded-2xl shadow-xl w-full max-w-7xl">

                                    <!-- Exit Button -->
                                    <button @click="viewOpen = false"
                                            class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                  d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                                                        <h2 class="text-2xl font-bold text-blue-600 mb-2">User Details</h2>
                                    <hr class="mb-6 border-blue-200">

                                    <!-- Info Grid -->
                                    <!-- Info Grid -->
                                    <div id="userDetailsContainer(${user.idusers})"></div>

                                </div>
                            </div>
                        </div>
                        <div x-data="{ confirmLogin: false }">
                            <button style="display: none;" disabled @click="confirmLogin = true"
                                    class="text-blue-500 hover:text-blue-700" title="Login">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none"
                                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path d="m10 17 5-5-5-5"/>
                                    <path d="M15 12H3"/>
                                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                </svg>
                            </button>

                            <!-- Modal -->
                            <div x-show="confirmLogin" x-cloak x-transition
                                 class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">

                                <div @click.away="confirmLogin = false"
                                     class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md text-center space-y-4">

                                    <h2 class="text-2xl font-bold text-gray-800">Proceed to Login?</h2>
                                    <p class="text-gray-600">Are you sure you want to continue?</p>

                                    <div class="flex justify-center gap-4 mt-6">
                                        <!-- Yes Button -->
                                        <button disabled @click="confirmLogin = false; openLoginUser(${user.idusers})"
                                                class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">
                                            Login
                                        </button>

                                        <!-- No Button -->
                                        <button @click="confirmLogin = false"
                                                class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl hover:bg-gray-400 transition">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div x-data="{ open: false }">

                            <!-- Trigger Button -->
                            <button @click="open = true; openEditUser(${user.idusers})"
                                    class="text-yellow-500 hover:text-yellow-600"
                                    title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24"
                                     stroke="currentColor" stroke-width="2">
                                    <path d="M2 21a8 8 0 0 1 10.821-7.487"/>
                                    <path d="M21.378 16.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/>
                                    <circle cx="10" cy="8" r="5"/>
                                </svg>
                            </button>
                        </div>
                        <div x-data="{ confirmDelete: false }">
                            <!-- Delete Trigger -->
                            <button @click="confirmDelete = true"
                                    class="text-red-500 hover:text-red-600" title="Update Account Status">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-cog-icon lucide-user-cog"><path d="M10 15H6a4 4 0 0 0-4 4v2"/><path d="m14.305 16.53.923-.382"/><path d="m15.228 13.852-.923-.383"/><path d="m16.852 12.228-.383-.923"/><path d="m16.852 17.772-.383.924"/><path d="m19.148 12.228.383-.923"/><path d="m19.53 18.696-.382-.924"/><path d="m20.772 13.852.924-.383"/><path d="m20.772 16.148.924.383"/><circle cx="18" cy="15" r="3"/><circle cx="9" cy="7" r="4"/></svg>
                            </button>

                            <!-- Modal -->
                            <div x-show="confirmDelete" x-cloak x-transition
                                 class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">

                                <div @click.away="confirmDelete = false"
                                     class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md text-center space-y-4">

                                    <h2 class="text-2xl font-bold text-gray-800">Confirm Needed.!</h2>
                                    <p class="text-gray-600">Please confirm if you want to change the status of this account to either Active or Inactive. The accountâ€™s current status will be updated accordingly</p>

                                    <div class="flex justify-center gap-4 mt-6">
                                        <!-- Yes Button -->
                                        <button @click="confirmDelete = false; MyProfileChange(${user.idusers})"
                                                class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition">
                                            Change Status
                                        </button>

                                        <!-- No Button -->
                                        <button @click="confirmDelete = false"
                                                class="bg-gray-300 text-gray-800 px-4 py-2 rounded-xl hover:bg-gray-400 transition">
                                            Not Needed
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
        `;

            tableBody.appendChild(row);
        });

        if (completed) {
            console.log("All users loaded");
            // Initialize DataTable now
            initDataTable();
            return;
        }

        // Wait 100ms before next batch
        await new Promise(resolve => setTimeout(resolve, 5));

        // Fetch next batch
        await fetchAndAppendUsers(limit, offset + limit);
    }

    document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("userTableBody").innerHTML = "";
        await fetchAndAppendUsers();
    });

    document.querySelectorAll('.dataTables_filter input').forEach(el => {
        el.classList.add(
            'text-sm',        // <-- Adjust font size here (e.g., text-sm, text-base, text-lg)
            'border', 'border-gray-300', 'rounded-md', 'px-4', 'py-2', 'ml-2',
            'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500', 'transition', 'shadow-sm'
        );
    });
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        $('#searchForm').on('submit', async function (e) {
            e.preventDefault();

            $('#datatable').DataTable().clear().draw();
            if ($.fn.DataTable.isDataTable('#datatable')) {
                $('#datatable').DataTable().destroy(); // destroy previous instance if any
            }
            await fetchAndAppendUsers();
        });
    });
    document.getElementById('resetLink').addEventListener('click', function(e) {
        e.preventDefault(); // prevent default link behavior
        document.getElementById('searchForm').reset(); // reset the form
    });
</script>
<script>
    function initDataTable() {
        if ($.fn.DataTable.isDataTable('#datatable')) {
            $('#datatable').DataTable().destroy();
        }

        $('#datatable').DataTable({
            pageLength: 100,
            lengthMenu: [20, 50, 100, 150, 200],
            dom:
                "<'flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4'" +
                    "<'flex items-center space-x-4 dt-export-wrap'<'export-label'>B l>" + // l moved here next to buttons
                    "<'dataTables_filter'f>>" +
                "<'overflow-x-auto'tr>" +
                "<'flex flex-col sm:flex-row sm:justify-between sm:items-center mt-4'<'dataTables_info'i><'dataTables_paginate custom-paging'p>>",

            buttons: [
                {
                    extend: 'copy',
                    text: 'Copy',
                    className: 'text-sm bg-gray-100 text-gray-800 border border-gray-200 rounded px-4 py-2 hover:bg-gray-200'
                },
                {
                    extend: 'csv',
                    className: 'text-sm bg-blue-100 text-blue-800 border border-blue-200 rounded px-4 py-2 hover:bg-blue-200'
                },
                {
                    extend: 'excel',
                    className: 'text-sm bg-green-100 text-green-800 border border-green-200 rounded px-4 py-2 hover:bg-green-200'
                }
            ],

            language: {
                lengthMenu: "_MENU_",
                paginate: {
                    previous: `
                        <span class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded hover:bg-gray-100 transition">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                          </svg>
                          Prev
                        </span>`,
                    next: `
                        <span class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded hover:bg-gray-100 transition">
                          Next
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                          </svg>
                        </span>`
                }
            },

            drawCallback: function () {
                document.querySelectorAll('.paginate_button:not(.previous):not(.next)').forEach(btn => {
                    btn.style.display = 'none';
                });
            },

            initComplete: function () {
                const exportWrap = document.querySelector('.dt-export-wrap');
                if (exportWrap) {
                    const label = document.createElement('span');
                    label.textContent = '';
                    label.className = 'text-sm text-gray-700 font-medium';
                    exportWrap.querySelector('.export-label').appendChild(label);
                }

                // Search box styling + increased size
                document.querySelectorAll('.dataTables_filter input').forEach(el => {
                    el.classList.add('border', 'border-gray-300', 'rounded', 'px-2', 'py-1', 'ml-1', 'focus:outline-none', 'w-64');
                });

                // Page length dropdown styling + match button height
                document.querySelectorAll('.dataTables_length select').forEach(el => {
                    el.classList.add('border', 'border-gray-300', 'rounded', 'px-4',"mt-2", 'py-1', 'focus:outline-none', 'h-full');
                });

                document.querySelectorAll('.dataTables_paginate').forEach(el => {
                    el.classList.add('flex', 'gap-2', 'items-center');
                });

                // Add hover effect to table rows
                document.querySelectorAll('#datatable tbody tr').forEach(row => {
                    row.classList.add('hover:bg-gray-100', 'transition');
                });
            }
        });
    }
</script>

<script type="module">
    import { API_BASE_URL } from "/static/apiConfig.js";
    window.API_BASE_URL = API_BASE_URL;
</script>

<script>

    async function fetchUserData(id) {
        const url = `${window.API_BASE_URL}/users/profile_detail`;
        const headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
        };
        const body = JSON.stringify({
            jwt_token: 'string',  // replace with real token if needed
            user_id: id,
        });

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: body,
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const users = data.users.result
            const user = users[0];
            return user;
        } catch (error) {
            console.error('Failed to fetch user data:', error);
            return null;
        }
    }

    function renderUserDetails(user) {
        return `
        <div class="max-w-7xl w-full mx-auto bg-white rounded-lg shadow-md p-8 overflow-auto">
          <table class="min-w-full border border-gray-200 divide-y divide-gray-200 text-left text-lg">
            <tbody class="bg-white divide-y divide-gray-200">
              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200 w-1/4">Username</th>
                <td class="px-6 py-3 font-bold text-gray-900 w-1/4">${user.username || ''}</td>

                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Email</th>
                <td class="px-6 py-3 font-bold text-indigo-700 truncate w-1/4">${user.email || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Status</th>
                <td class="px-6 py-3 font-bold text-green-600">${user.status === 1 ? 'Active' : 'Inactive'}</td>

                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Role</th>
                <td class="px-6 py-3 font-bold text-indigo-700">${user.role_name || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Registered</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.createddate || ''}</td>

                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Last Updated</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.updateddate || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Admin Rights?</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.is_admin === 1 ? 'YES' : 'NO'}</td>

                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">CNIC</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.cnic || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">CNIC Expiry</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.cnicexpiry || ''}</td>

                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Mobile</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.mobile || ''}</td>
              </tr>

              <!-- New row for Address -->
              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200 align-top">Address</th>
                <td class="px-6 py-3 font-bold text-gray-800 truncate whitespace-normal" colspan="3">
                  ${user.current_address || ''}
                </td>
              </tr>

              <!-- Additional 6 rows -->
              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Province</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.province || ''}</td>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Division</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.division || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">District</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.district_name || ''}</td>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Tehsil</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.tehsil_name || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Union Councils</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.uc_names || ''}</td>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Designation</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.designation || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Affiliation</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.affiliation || ''}</td>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Entry Permission</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.entrypermission || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Gender</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.genderval || ''}</td>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Full Name</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.first_name || ''} ${user.last_name || ''}</td>
              </tr>

              <tr>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-r border-gray-200">Created By</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.createdby_username || ''}</td>
                <th class="px-6 py-3 font-semibold text-gray-600 uppercase border-l border-gray-200 border-r">Updated By</th>
                <td class="px-6 py-3 font-bold text-gray-800">${user.updatedby_username || ''}</td>
              </tr>
            </tbody>
          </table>
        </div>
        `;
        }

    async function openViewUser(id) {
        try {
            console.log('openViewUser called for:', id);
            const userData = await fetchUserData(id);

            // Select the container with dynamic ID
            const container = document.getElementById(`userDetailsContainer(${id})`);
            if (!container) {
                console.error(`Container for user ID ${id} not found`);
                return;
            }

            // Render user data inside that container
            container.innerHTML = renderUserDetails(userData);

            // Optionally, open modal or make container visible if hidden
            // For example:
            // const modal = document.getElementById('userModal');
            // modal.classList.remove('hidden');

        } catch (error) {
            console.error("Failed to fetch user data:", error);
        }
    }


    function openLoginUser(id) {
        console.log("Confirming login for user:", id);
        // your login confirmation logic
    }
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openEditUser(id) {
        const csrfToken = getCookie('csrftoken');

        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/usermanagement/edit_profile/"; // exact Django URL
        form.target = "_blank"; // open in new tab

        // user_id
        const userIdField = document.createElement("input");
        userIdField.type = "hidden";
        userIdField.name = "user_id";
        userIdField.value = id;
        form.appendChild(userIdField);

        // CSRF
        const csrfField = document.createElement("input");
        csrfField.type = "hidden";
        csrfField.name = "csrfmiddlewaretoken";
        csrfField.value = csrfToken;
        form.appendChild(csrfField);

        // Append to DOM and submit
        document.body.appendChild(form);
        form.submit();
        // form.remove(); // cleanup
    }



    async function MyProfileChange(id) {
        try {
            const toggleStatusUrl = "{% url 'usermanagement:change_my_profile' %}";
            console.log("Toggling status for user:", id);

            const response = await fetch(toggleStatusUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ idusers: id })
            });

            const data = await response.json();

            Swal.fire({
                icon: data.status === 'success' ? 'success' : 'error',
                title: data.status === 'success' ? 'Success' : 'Error',
                text: data.message,
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true
            });

        } catch (err) {
            console.error("Error toggling status:", err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Unexpected error occurred',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true
            });
        }
    }

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

</script>
{% include "partial_js_func/user_form_creation.js" %}

{% endblock %}
